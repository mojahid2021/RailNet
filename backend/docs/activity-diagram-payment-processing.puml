@startuml Payment Processing Flow
!theme plain
title Payment Processing Activity Diagram

|User|
start
:Complete ticket booking;
:Initiate payment;
:Provide customer details;

|#LightBlue|Payment Service|
:Receive payment initiation request;
:Verify JWT token;

partition "Payment Initialization" {
  :Fetch user details\nfrom database;
  
  :Fetch ticket details\nby ticketId;
  
  if (Ticket exists?) then (no)
    :Return 404 error\n"Ticket not found";
    stop
  else (yes)
    if (Ticket belongs to user?) then (no)
      :Return 403 error\n"Unauthorized access";
      stop
    else (yes)
      if (Payment status is pending?) then (no)
        :Return 400 error\n"Invalid payment status";
        stop
      else (yes)
        :Generate transaction ID\n"TXN_timestamp_ticketId";
        
        :Create PaymentTransaction record:
        - transactionId
        - ticketId
        - amount (ticket price)
        - currency (BDT)
        - status: "INITIATED"
        - metadata (customer details);
        
        :Construct callback URLs:
        - Success URL
        - Fail URL
        - Cancel URL
        - IPN URL;
        
        |#Orange|SSLCommerz Gateway|
        :Send payment request\nto SSLCommerz API;
        
        :Receive gateway session;
        
        |#LightBlue|Payment Service|
        :Update transaction with:
        - sessionKey
        - gatewayUrl;
        
        :Create PaymentLog\naction: "INITIATED";
        
        :Return payment URL\nand transaction ID;
        
        |User|
        :Redirect to\nSSLCommerz gateway;
        
        :Enter payment details\n(card/mobile banking);
        
        |#Orange|SSLCommerz Gateway|
        :Process payment;
        
        if (Payment successful?) then (yes)
          partition "Success Flow" {
            :Redirect to success URL\nwith payment details;
            
            |#LightBlue|Payment Service|
            :Receive success callback;
            
            :Validate payment with\nSSLCommerz validation API;
            
            if (Payment valid?) then (yes)
              :Update PaymentTransaction:
              - status: "COMPLETED"
              - bankTransactionId
              - valId
              - cardType
              - completedAt;
              
              :Update Ticket:
              - status: "confirmed"
              - paymentStatus: "paid"
              - confirmedAt;
              
              :Create PaymentLog\naction: "COMPLETED";
              
              :Return success page;
              
              |User|
              :View booking confirmation;
              stop
            else (no)
              :Update transaction\nstatus: "FAILED";
              :Return error page;
              stop
            endif
          }
        else (no - failed)
          partition "Failure Flow" {
            :Redirect to fail URL;
            
            |#LightBlue|Payment Service|
            :Receive fail callback;
            
            :Update PaymentTransaction:
            - status: "FAILED"
            - errorMessage;
            
            :Update Ticket\npaymentStatus: "failed";
            
            :Create PaymentLog\naction: "FAILED";
            
            :Return failure page;
            
            |User|
            :View payment failed message;
            :Option to retry payment;
            stop
          }
        endif
      endif
    endif
  endif
}

note right of "SSLCommerz Gateway"
  External payment gateway
  handles actual payment
  processing securely
end note

note left of "Validate payment"
  Additional validation step
  ensures payment authenticity
  and prevents fraud
end note

|#Orange|SSLCommerz Gateway|
partition "IPN (Instant Payment Notification)" {
  :Send IPN POST request\nto backend (async);
  
  |#LightBlue|Payment Service|
  :Receive IPN data;
  
  :Verify transaction\nwith SSLCommerz API;
  
  :Update PaymentTransaction\nif needed;
  
  :Create PaymentLog\naction: "IPN_RECEIVED";
  
  :Return 200 OK;
}

note right of "IPN"
  IPN provides server-to-server
  notification for payment status
  updates, independent of user
  browser redirects
end note

@enduml
