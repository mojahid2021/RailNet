@startuml RailNet Backend Class Diagram
!theme plain
skinparam linetype ortho
skinparam classAttributeIconSize 0
skinparam packageStyle rectangle

title RailNet Backend - Class Diagram

package "Data Models (Prisma Schema)" {
  class User {
    +id: Int
    +email: String
    +firstName: String?
    +lastName: String?
    +phone: String?
    +address: String?
    +password: String
    +role: String
    +tickets: Ticket[]
    +createdAt: DateTime
    +updatedAt: DateTime
  }

  class Station {
    +id: Int
    +name: String
    +city: String
    +latitude: Float
    +longitude: Float
    +previousStations: RouteStation[]
    +currentStations: RouteStation[]
    +nextStations: RouteStation[]
    +startRoutes: TrainRoute[]
    +endRoutes: TrainRoute[]
    +scheduleStations: ScheduleStation[]
    +fromTickets: Ticket[]
    +toTickets: Ticket[]
    +createdAt: DateTime
    +updatedAt: DateTime
  }

  class TrainRoute {
    +id: Int
    +name: String
    +startStationId: Int
    +endStationId: Int
    +startStation: Station
    +endStation: Station
    +routeStations: RouteStation[]
    +trains: Train[]
    +schedules: TrainSchedule[]
    +createdAt: DateTime
    +updatedAt: DateTime
  }

  class RouteStation {
    +id: Int
    +trainRouteId: Int
    +trainRoute: TrainRoute
    +previousStationId: Int?
    +currentStationId: Int
    +nextStationId: Int?
    +distance: Float?
    +distanceFromStart: Float
    +previousStation: Station?
    +currentStation: Station
    +nextStation: Station?
    +createdAt: DateTime
    +updatedAt: DateTime
  }

  class Compartment {
    +id: Int
    +name: String
    +class: String
    +type: String
    +price: Float
    +totalSeats: Int
    +trainCompartments: TrainCompartment[]
    +createdAt: DateTime
    +updatedAt: DateTime
  }

  class Train {
    +id: Int
    +name: String
    +number: String
    +trainRouteId: Int
    +trainRoute: TrainRoute
    +compartments: TrainCompartment[]
    +schedules: TrainSchedule[]
    +createdAt: DateTime
    +updatedAt: DateTime
  }

  class TrainCompartment {
    +id: Int
    +trainId: Int
    +compartmentId: Int
    +quantity: Int
    +train: Train
    +compartment: Compartment
    +seats: Seat[]
    +tickets: Ticket[]
    +compartmentBookings: CompartmentBooking[]
    +createdAt: DateTime
    +updatedAt: DateTime
  }

  class Seat {
    +id: Int
    +trainCompartmentId: Int
    +trainCompartment: TrainCompartment
    +seatNumber: String
    +isAvailable: Boolean
    +ticket: Ticket?
    +createdAt: DateTime
    +updatedAt: DateTime
  }

  class TrainSchedule {
    +id: Int
    +trainId: Int
    +trainRouteId: Int
    +train: Train
    +trainRoute: TrainRoute
    +date: DateTime
    +time: String
    +stationTimes: ScheduleStation[]
    +tickets: Ticket[]
    +compartmentBookings: CompartmentBooking[]
    +createdAt: DateTime
    +updatedAt: DateTime
  }

  class ScheduleStation {
    +id: Int
    +trainScheduleId: Int
    +trainSchedule: TrainSchedule
    +stationId: Int
    +station: Station
    +arrivalTime: String?
    +departureTime: String?
    +sequence: Int
    +createdAt: DateTime
    +updatedAt: DateTime
  }

  class Ticket {
    +id: Int
    +ticketId: String
    +userId: Int
    +user: User
    +trainScheduleId: Int
    +trainSchedule: TrainSchedule
    +fromStationId: Int
    +fromStation: Station
    +toStationId: Int
    +toStation: Station
    +seatId: Int
    +seat: Seat
    +trainCompartmentId: Int
    +trainCompartment: TrainCompartment
    +seatNumber: String
    +passengerName: String
    +passengerAge: Int
    +passengerGender: String
    +price: Float
    +status: String
    +paymentStatus: String
    +expiresAt: DateTime?
    +confirmedAt: DateTime?
    +paymentTransactions: PaymentTransaction[]
    +createdAt: DateTime
    +updatedAt: DateTime
  }

  class PaymentTransaction {
    +id: String
    +ticketId: Int
    +ticket: Ticket
    +transactionId: String
    +sessionKey: String?
    +amount: Float
    +currency: String
    +status: String
    +paymentMethod: String?
    +bankTransactionId: String?
    +valId: String?
    +cardType: String?
    +completedAt: DateTime?
    +gatewayUrl: String?
    +errorMessage: String?
    +metadata: Json?
    +sslcommerzData: Json?
    +createdAt: DateTime
    +updatedAt: DateTime
  }

  class PaymentLog {
    +id: String
    +transactionId: String
    +action: String
    +details: Json
    +createdAt: DateTime
  }

  class CompartmentBooking {
    +id: Int
    +trainScheduleId: Int
    +trainSchedule: TrainSchedule
    +trainCompartmentId: Int
    +trainCompartment: TrainCompartment
    +bookedSeats: Int
    +totalSeats: Int
    +createdAt: DateTime
    +updatedAt: DateTime
  }
}

' Relationships
User "1" -- "*" Ticket : creates
Station "1" -- "*" RouteStation : "has positions"
Station "1" -- "*" TrainRoute : "start/end"
TrainRoute "1" -- "*" RouteStation : contains
TrainRoute "1" -- "*" Train : defines
TrainRoute "1" -- "*" TrainSchedule : schedules
Train "1" -- "*" TrainCompartment : has
Compartment "1" -- "*" TrainCompartment : defines
TrainCompartment "1" -- "*" Seat : contains
Train "1" -- "*" TrainSchedule : scheduled
TrainSchedule "1" -- "*" ScheduleStation : "has stops"
TrainSchedule "1" -- "*" Ticket : booked
TrainSchedule "1" -- "*" CompartmentBooking : tracks
Station "1" -- "*" ScheduleStation : "stop at"
Ticket "1" -- "1" Seat : reserves
Ticket "1" -- "1" PaymentTransaction : processes
Ticket "*" -- "1" Station : "from/to"
TrainCompartment "1" -- "*" Ticket : books
TrainCompartment "1" -- "*" CompartmentBooking : manages

package "Services Layer" {
  class PaymentService {
    -sslcommerz: SSLCommerzClient
    +initiatePayment(paymentData: PaymentData): Promise<{paymentUrl, transactionId}>
    +handleSuccessCallback(data: any): Promise<void>
    +handleFailCallback(data: any): Promise<void>
    +handleCancelCallback(data: any): Promise<void>
    +handleIPNCallback(data: any): Promise<void>
    +validatePayment(valId: string): Promise<ValidationResponse>
  }

  class BookingCleanupService {
    +cleanupExpiredBookings(expiryMinutes: number): Promise<CleanupResult>
    +getCleanupStatistics(): Promise<CleanupStats>
    -cancelExpiredBooking(ticket: Ticket): Promise<void>
  }

  class CleanupJobs {
    -cleanupInterval: NodeJS.Timer
    -statsInterval: NodeJS.Timer
    +start(): void
    +stop(): void
    -scheduleCleanup(): void
    -logStatistics(): void
  }
}

package "Route Handlers" {
  class AuthRoutes {
    +POST /register
    +POST /login
  }

  class StationRoutes {
    +GET /stations
    +GET /stations/:id
    +POST /stations (admin)
    +PUT /stations/:id (admin)
    +DELETE /stations/:id (admin)
  }

  class TrainRouteRoutes {
    +GET /train-routes (admin)
    +GET /train-routes/:id (admin)
    +POST /train-routes (admin)
  }

  class CompartmentRoutes {
    +GET /compartments
    +GET /compartments/:id
    +POST /compartments (admin)
    +PUT /compartments/:id (admin)
    +DELETE /compartments/:id (admin)
  }

  class TrainRoutes {
    +GET /trains
    +GET /trains/:id
    +POST /trains (admin)
    +PUT /trains/:id (admin)
    +DELETE /trains/:id (admin)
  }

  class TrainScheduleRoutes {
    +GET /train-schedules
    +GET /train-schedules/:id
    +GET /train-schedules/date/:date
    +GET /train-schedules/route/:routeId
    +GET /train-schedules/search
    +GET /train-schedules/:id/seats
    +GET /train-schedules/:id/available-seats
    +POST /train-schedules (admin)
    +PUT /train-schedules/:id (admin)
    +DELETE /train-schedules/:id (admin)
  }

  class TicketRoutes {
    +GET /tickets
    +GET /tickets/:id
    +POST /tickets
    +PUT /tickets/:id/cancel
  }

  class PaymentRoutes {
    +POST /payments/initiate
    +GET /payments/success (callback)
    +GET /payments/fail (callback)
    +GET /payments/cancel (callback)
    +POST /payments/ipn (callback)
    +POST /payments/cleanup (admin)
    +GET /payments/cleanup/stats (admin)
  }
}

package "Utilities" {
  class SSLCommerzClient {
    -storeId: string
    -storePassword: string
    -isSandbox: boolean
    -apiUrl: string
    +initiatePayment(paymentRequest: PaymentRequest): Promise<PaymentResponse>
    +validatePayment(valId: string): Promise<ValidationResponse>
  }

  class PrismaClient {
    +user: UserDelegate
    +station: StationDelegate
    +trainRoute: TrainRouteDelegate
    +compartment: CompartmentDelegate
    +train: TrainDelegate
    +ticket: TicketDelegate
    +paymentTransaction: PaymentTransactionDelegate
    +...other models
  }
}

' Service Dependencies
PaymentService ..> PaymentTransaction : creates/updates
PaymentService ..> Ticket : updates
PaymentService ..> SSLCommerzClient : uses
BookingCleanupService ..> Ticket : updates
BookingCleanupService ..> PaymentTransaction : cancels
CleanupJobs ..> BookingCleanupService : uses
PaymentRoutes ..> PaymentService : uses
TicketRoutes ..> Ticket : creates
TicketRoutes ..> Seat : manages

note right of PaymentService
  Handles SSLCommerz payment 
  gateway integration including:
  - Payment initiation
  - Success/Fail callbacks
  - IPN notifications
  - Payment validation
end note

note right of BookingCleanupService
  Manages automatic cleanup of:
  - Expired pending bookings
  - Cancelled transactions
  - Freed seats
end note

note right of CleanupJobs
  Scheduled background jobs:
  - Every 5 min: cleanup expired bookings
  - Every 10 min: log statistics
end note

@enduml
