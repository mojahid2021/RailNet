@startuml System Architecture and Data Flow
!theme plain
title RailNet Backend - System Architecture & Data Flow

' Define components
package "Client Layer" {
  component [Android App] as mobile
  component [Web Dashboard] as web
  component [Admin Panel] as admin
}

package "API Layer" {
  component [Fastify Server] as server
  component [JWT Middleware] as jwt
  component [Rate Limiter] as ratelimit
  component [CORS] as cors
  component [Swagger/OpenAPI] as swagger
}

package "Route Handlers" {
  component [Auth Routes] as authRoutes
  component [Station Routes] as stationRoutes
  component [Train Routes] as trainRoutes
  component [Schedule Routes] as scheduleRoutes
  component [Ticket Routes] as ticketRoutes
  component [Payment Routes] as paymentRoutes
}

package "Service Layer" {
  component [Payment Service] as paymentSvc
  component [Cleanup Service] as cleanupSvc
  component [Cleanup Jobs\n(Scheduler)] as cleanupJobs
}

package "External Services" {
  component [SSLCommerz\nPayment Gateway] as sslcommerz
}

database "PostgreSQL\nDatabase" {
  frame "Core Tables" {
    component [Users] as userTbl
    component [Stations] as stationTbl
    component [Trains] as trainTbl
    component [Routes] as routeTbl
  }
  
  frame "Booking Tables" {
    component [Schedules] as scheduleTbl
    component [Tickets] as ticketTbl
    component [Seats] as seatTbl
  }
  
  frame "Payment Tables" {
    component [PaymentTransactions] as paymentTbl
    component [PaymentLogs] as logTbl
  }
}

component [Prisma ORM] as prisma

' Client connections
mobile -down-> server : HTTPS/REST
web -down-> server : HTTPS/REST
admin -down-> server : HTTPS/REST

' API Layer connections
server -down-> cors
server -down-> ratelimit
server -down-> jwt
server -down-> swagger

' Route handler connections
server -down-> authRoutes
server -down-> stationRoutes
server -down-> trainRoutes
server -down-> scheduleRoutes
server -down-> ticketRoutes
server -down-> paymentRoutes

' Service layer connections
paymentRoutes -down-> paymentSvc
ticketRoutes -down-> cleanupSvc
paymentRoutes -down-> cleanupSvc

' Background jobs
cleanupJobs -down-> cleanupSvc : Every 5 min
cleanupJobs ..> paymentSvc : Stats logging

' External service connections
paymentSvc -right-> sslcommerz : Payment API
sslcommerz -left-> paymentRoutes : Callbacks/IPN

' Database connections
authRoutes -down-> prisma
stationRoutes -down-> prisma
trainRoutes -down-> prisma
scheduleRoutes -down-> prisma
ticketRoutes -down-> prisma
paymentSvc -down-> prisma
cleanupSvc -down-> prisma

prisma -down-> userTbl
prisma -down-> stationTbl
prisma -down-> trainTbl
prisma -down-> routeTbl
prisma -down-> scheduleTbl
prisma -down-> ticketTbl
prisma -down-> seatTbl
prisma -down-> paymentTbl
prisma -down-> logTbl

' Data flow annotations
note right of mobile
  Mobile app sends requests
  with JWT token in headers
end note

note right of jwt
  Validates JWT tokens
  Role-based access:
  - user
  - admin
end note

note right of paymentSvc
  Orchestrates payment flow:
  1. Initiate payment
  2. Handle callbacks
  3. Validate with gateway
  4. Update ticket status
end note

note right of cleanupJobs
  Background processes:
  - Cleanup expired bookings
  - Free up seats
  - Cancel transactions
  - Log statistics
end note

note bottom of prisma
  Type-safe database access
  Transaction support
  Migration management
end note

note left of sslcommerz
  External payment gateway
  Handles secure payments
  Sends callbacks/IPN
end note

' Legend
legend right
  |= Symbol |= Meaning |
  | â†’ | Data flow |
  | ..> | Scheduled/Async |
  | HTTPS/REST | Secure API calls |
  | JWT | Authentication |
endlegend

@enduml
