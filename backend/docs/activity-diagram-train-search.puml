@startuml Train Search and Seat Availability Flow
!theme plain
title Train Search & Seat Availability Activity Diagram

|User|
start
:Access train search;
:Enter search criteria:
- From Station
- To Station
- Travel Date;
:Submit search request;

|#LightBlue|Backend API|
:Receive search request;
:Verify JWT token;

if (User authenticated?) then (no)
  :Return 401 error\n"Authentication required";
  stop
else (yes)
  partition "Search Trains" {
    :Validate station IDs exist;
    
    if (Stations exist?) then (no)
      :Return 404 error\n"Station not found";
      stop
    else (yes)
      :Query TrainSchedules:
      - date matches
      - route contains both stations
      - from station before to station;
      
      if (Found schedules?) then (no)
        :Return empty result\n"No trains available";
        
        |User|
        :View "No trains found" message;
        stop
      else (yes)
        :For each schedule, fetch:
        - Train details
        - Route information
        - Station sequences
        - Compartments with pricing;
        
        :Filter schedules where\nfrom station sequence < to station sequence;
        
        :Calculate distances\nbetween stations;
        
        :Calculate prices for\neach compartment type;
        
        :Format response with:
        - Schedule ID
        - Train name & number
        - Departure/Arrival times
        - Journey duration
        - Available compartments
        - Pricing per compartment;
        
        :Return search results;
        
        |User|
        :View available trains\nwith prices;
        
        :Select a train;
        :Click to view seat availability;
      endif
    endif
  }
  
  |User|
  :Request seat availability\nfor selected schedule;
  
  |#LightBlue|Backend API|
  partition "Check Seat Availability" {
    :Receive availability request:
    - scheduleId
    - fromStationId
    - toStationId;
    
    :Fetch train schedule\nwith compartments;
    
    if (Schedule exists?) then (no)
      :Return 404 error\n"Schedule not found";
      stop
    else (yes)
      :Verify stations are\nin route;
      
      if (Stations valid?) then (no)
        :Return 400 error\n"Invalid station sequence";
        stop
      else (yes)
        :For each train compartment:;
        
        partition "Calculate Availability" {
          :Get total seats\nfrom compartment definition;
          
          :Query booked seats:
          - Same train schedule
          - Same compartment
          - Overlapping journey segments;
          
          note right
            Journey overlaps if:
            - Booked from station < requested to station
            - Booked to station > requested from station
          end note
          
          :Count unique seat numbers\nbooked for overlapping journeys;
          
          :Calculate available seats:
          total seats - booked seats;
          
          :Generate list of\navailable seat numbers;
          
          :Calculate price:
          distance * compartment price/km;
        }
        
        :Aggregate compartment data:
        - Compartment name/class/type
        - Total seats
        - Booked seats
        - Available seats
        - Available seat numbers
        - Price for journey;
        
        :Return availability response;
        
        |User|
        :View seat map with:
        - Available seats (green)
        - Booked seats (red)
        - Prices per compartment;
        
        :Select desired seat number;
        :Click "Book Ticket";
        
        -> Proceed to ticket booking;
        stop
      endif
    endif
  }
endif

note right of "Query booked seats"
  Sophisticated overlap logic ensures
  accurate availability by checking
  if any part of the user's journey
  conflicts with existing bookings
end note

note left of "Generate available seat numbers"
  Seat numbers are pre-defined
  (e.g., 1A, 1B, 2A, 2B...)
  and only booked seats are
  excluded from available list
end note

@enduml
