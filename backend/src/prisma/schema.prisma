// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// User management
model User {
  id        String   @id @default(cuid())
  email     String   @unique
  password  String
  firstName String?
  lastName  String?
  role      UserRole @default(PASSENGER)
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  bookings     Booking[]
  payments     Payment[]
  notifications Notification[]

  @@map("users")
}

// Railway infrastructure
model Station {
  id        String   @id @default(cuid())
  name      String
  code      String   @unique
  city      String
  state     String?
  country   String   @default("India")
  latitude  Float?
  longitude Float?
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  routeStops RouteStop[]

  @@map("stations")
}

model CoachType {
  id             String  @id @default(cuid())
  name           String  @unique
  code           String  @unique
  description    String?
  ratePerKm      Float   // Rate per kilometer in INR
  isActive       Boolean @default(true)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  @@map("coach_types")
}

model Train {
  id          String        @id @default(cuid())
  name        String
  number      String        @unique
  type        TrainType
  totalSeats  Int
  isActive    Boolean       @default(true)
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt

  // Relations
  routes      Route[]
  schedules   Schedule[]

  @@map("trains")
}

// Routes and schedules
model Route {
  id          String     @id @default(cuid())
  trainId     String
  name        String
  distance    Float
  duration    Int        // in minutes
  isActive    Boolean    @default(true)
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt

  // Relations
  train       Train      @relation(fields: [trainId], references: [id], onDelete: Cascade)
  stops       RouteStop[]
  schedules   Schedule[]

  @@map("routes")
}

model RouteStop {
  id         String  @id @default(cuid())
  routeId    String
  stationId  String
  stopOrder  Int
  arrivalTime   String? // HH:MM format
  departureTime String? // HH:MM format
  distance   Float   @default(0)

  // Relations
  route    Route   @relation(fields: [routeId], references: [id], onDelete: Cascade)
  station  Station @relation(fields: [stationId], references: [id])

  @@unique([routeId, stationId])
  @@unique([routeId, stopOrder])
  @@map("route_stops")
}

model Schedule {
  id            String            @id @default(cuid())
  routeId       String
  trainId       String
  departureDate DateTime
  arrivalDate   DateTime
  status        ScheduleStatus    @default(SCHEDULED)
  createdAt     DateTime          @default(now())
  updatedAt     DateTime          @updatedAt

  // Relations
  route         Route             @relation(fields: [routeId], references: [id], onDelete: Cascade)
  train         Train             @relation(fields: [trainId], references: [id], onDelete: Cascade)
  bookings      Booking[]

  @@map("schedules")
}

// Bookings and payments
model Booking {
  id            String         @id @default(cuid())
  userId        String
  scheduleId    String
  seatNumber    String
  bookingStatus BookingStatus @default(CONFIRMED)
  totalAmount   Float
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt

  // Relations
  user          User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  schedule      Schedule       @relation(fields: [scheduleId], references: [id])
  payment       Payment?

  @@unique([scheduleId, seatNumber])
  @@map("bookings")
}

model Payment {
  id            String        @id @default(cuid())
  bookingId     String        @unique
  userId        String
  amount        Float
  paymentMethod String
  paymentStatus PaymentStatus @default(PENDING)
  transactionId String?       @unique
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt

  // Relations
  booking       Booking       @relation(fields: [bookingId], references: [id], onDelete: Cascade)
  user          User          @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("payments")
}

// Notifications
model Notification {
  id        String             @id @default(cuid())
  userId    String
  type      NotificationType
  title     String
  message   String
  isRead    Boolean            @default(false)
  createdAt DateTime           @default(now())

  // Relations
  user      User               @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("notifications")
}

// Enums
enum UserRole {
  ADMIN
  STAFF
  PASSENGER
}

enum TrainType {
  EXPRESS
  SUPERFAST
  MAIL
  PASSENGER
  SHATABDI
  RAJDHANI
}

enum ScheduleStatus {
  SCHEDULED
  DEPARTED
  ARRIVED
  CANCELLED
  DELAYED
}

enum BookingStatus {
  CONFIRMED
  CANCELLED
  REFUNDED
}

enum PaymentStatus {
  PENDING
  COMPLETED
  FAILED
  REFUNDED
}

enum NotificationType {
  BOOKING_CONFIRMATION
  PAYMENT_SUCCESS
  TRAIN_DELAY
  TRAIN_CANCELLATION
  GENERAL
}
